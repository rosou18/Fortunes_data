<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fortune Cookie</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        @font-face {
            font-family: 'CustomFont';
            src: url('fonts/font.ttf') format('truetype');
        }
        
        * {
            font-family: 'CustomFont', -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        .input-area {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 88%;
            max-width: 340px;
            z-index: 100;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        #wisdom-input {
            padding: 18px 22px;
            border: none;
            background: white;
            color: #dc2626;
            font-size: clamp(16px, 4.2vw, 19px);
            text-align: center;
            outline: none;
            border-radius: 10px;
            font-weight: 400;
            letter-spacing: 0.5px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #wisdom-input::placeholder {
            color: #dc262680;
            letter-spacing: 1px;
        }
        
        #exchange-btn {
            padding: 16px 20px;
            border: none;
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: clamp(15px, 4vw, 18px);
            font-weight: 400;
            text-transform: capitalize;
            letter-spacing: 2px;
            cursor: pointer;
            border: 1.5px solid rgba(255,255,255,0.5);
            transition: all 0.2s;
            border-radius: 10px;
        }
        
        #exchange-btn:active {
            background: rgba(255,255,255,0.2);
            transform: scale(0.98);
        }
        
        .fortune-text {
            position: fixed;
            bottom: 18%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: clamp(20px, 5.5vw, 26px);
            line-height: 1.5;
            text-align: center;
            max-width: 88%;
            width: 100%;
            opacity: 0;
            transition: opacity 0.4s;
            cursor: pointer;
            letter-spacing: 1px;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        .fortune-text.show {
            opacity: 1;
        }
        
        .fortune-text .thank-you {
            font-size: clamp(11px, 3vw, 13px);
            margin-top: 20px;
            opacity: 0.8;
            letter-spacing: 2px;
        }
        
        .count-display {
            position: fixed;
            top: clamp(40px, 8vh, 60px);
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.95);
            font-size: clamp(36px, 10vw, 56px);
            font-weight: 300;
            text-align: center;
            letter-spacing: 1px;
            width: 90%;
            line-height: 1.1;
        }
        
        .count-number {
            display: none;
        }
        
        .hidden {
            display: none;
        }

        /* Landscape phone orientation */
        @media (orientation: landscape) and (max-height: 500px) {
            .count-display {
                top: 10px;
                font-size: clamp(18px, 4vw, 22px);
            }
            
            .input-area {
                bottom: 10px;
                gap: 8px;
            }
            
            #wisdom-input {
                padding: 12px 16px;
            }
            
            #exchange-btn {
                padding: 10px 14px;
            }
            
            .fortune-text {
                bottom: 12%;
                font-size: clamp(16px, 4vw, 18px);
            }
        }

        /* Very small phones */
        @media (max-width: 360px) {
            .input-area {
                width: 90%;
            }
            
            #wisdom-input {
                padding: 14px 18px;
                font-size: 16px;
            }
            
            #exchange-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        /* Tablets and larger */
        @media (min-width: 768px) {
            .input-area {
                max-width: 400px;
            }
            
            .fortune-text {
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <div id="count-display" class="count-display">
        <span class="count-number">0</span>
        <div>Life Lesson Database</div>
    </div>

    <div id="input-section" class="input-area">
        <input type="text" id="wisdom-input" placeholder="Enter your wisdom">
        <button id="exchange-btn">Exchange</button>
    </div>
    
    <div id="fortune-display" class="fortune-text hidden">
        <div id="fortune-content"></div>
        <div class="thank-you">Thank you</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3R_s3DQkam2d9Dk_AXtp6dmPi7wxwX6g",
            authDomain: "fortunes-3747a.firebaseapp.com",
            projectId: "fortunes-3747a",
            storageBucket: "fortunes-3747a.firebasestorage.app",
            messagingSenderId: "688657577579",
            appId: "1:688657577579:web:98f96e46a9296dcd3a632e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let databaseFortunes = [];

        window.loadFortunes = async function() {
            try {
                const snapshot = await getDocs(collection(db, "fortunes"));
                databaseFortunes = [];
                snapshot.forEach((doc) => {
                    databaseFortunes.push(doc.data().text);
                });
                console.log(`Loaded ${databaseFortunes.length} fortunes from database`);
            } catch (error) {
                console.error("Error loading fortunes:", error);
            }
        };

        window.saveToFirestore = async function(wisdom) {
            try {
                await addDoc(collection(db, "fortunes"), {
                    text: wisdom,
                    timestamp: serverTimestamp(),
                    userSubmitted: true
                });
                databaseFortunes.push(wisdom);
                console.log("Wisdom saved to Firestore");
            } catch (error) {
                console.error("Error saving to Firestore:", error);
            }
        };

        window.addEventListener('load', () => {
            window.loadFortunes();
        });

        window.databaseFortunes = databaseFortunes;
    </script>

    <script>
        window.cookieImages = [];
        window.currentFrame = 0;
        window.fortuneCount = 0;

        const BASE_FORTUNES = [
            "Be who your younger self needed",
            "Change is the only constant",
            "Trust your gut",
            "What goes around comes around",
            "Serendipity",
            "It's a blessing in disguise",
            "Show don't tell",
            "Respect for one's body",
            "It's all about perspective",
            "Actions speak louder than words",
            "Life is all about how you handle plan b",
            "Find the good",
            "The way you speak to yourself matters",
            "What's meant for you won't pass you by",
            "It's a marathon, not a race",
            "Comparison is the thief of joy",
            "This too shall pass",
            "Do it for yourself",
            "Sink or swim",
            "No problems only solutions",
            "You reap what you sow",
            "Learn to let go",
            "Where there is a will, there is a way"
        ];

        function getRandomFortune() {
            const useDatabase = Math.random() < 0.5;
            
            if (useDatabase && window.databaseFortunes && window.databaseFortunes.length > 0) {
                const fortune = window.databaseFortunes[Math.floor(Math.random() * window.databaseFortunes.length)];
                console.log(`ðŸŽ² From DATABASE: "${fortune}"`);
                return fortune;
            } else {
                const fortune = BASE_FORTUNES[Math.floor(Math.random() * BASE_FORTUNES.length)];
                console.log(`ðŸ“œ From BASE LIST: "${fortune}"`);
                return fortune;
            }
        }

        function preload() {
            for (let i = 1; i <= 4; i++) {
                window.cookieImages.push(loadImage(`images/cookie${i}.jpg`));
            }
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            imageMode(CENTER);
            
            const saved = localStorage.getItem('fortuneCount');
            if (saved) {
                window.fortuneCount = parseInt(saved);
            }
            updateCountDisplay();
            
            document.getElementById('exchange-btn').addEventListener('click', showFortune);
            document.getElementById('wisdom-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    showFortune();
                }
            });
            document.getElementById('fortune-display').addEventListener('click', reset);
        }

        function draw() {
            background(212, 0, 0);
            
            window.currentFrame += 0.08;
            let frameIndex = floor(window.currentFrame) % window.cookieImages.length;
            
            if (window.cookieImages.length > 0) {
                // Better responsive sizing for balanced layout
                let maxSize = min(width * 0.6, height * 0.38);
                let imgSize = min(maxSize, 320);
                
                let img = window.cookieImages[frameIndex];
                if (img) {
                    let imgRatio = img.height / img.width;
                    // Better vertical centering
                    let yPos = height * 0.45;
                    image(img, width / 2, yPos, imgSize, imgSize * imgRatio);
                }
            }
        }

        async function showFortune() {
            const input = document.getElementById('wisdom-input');
            const inputSection = document.getElementById('input-section');
            const fortuneDisplay = document.getElementById('fortune-display');
            const fortuneContent = document.getElementById('fortune-content');
            
            if (!input.value.trim()) {
                input.style.backgroundColor = '#ffebee';
                setTimeout(() => {
                    input.style.backgroundColor = 'white';
                }, 1000);
                return;
            }
            
            // Blur input to hide mobile keyboard
            input.blur();
            
            await window.saveToFirestore(input.value.trim());
            
            window.fortuneCount++;
            updateCountDisplay();
            localStorage.setItem('fortuneCount', window.fortuneCount);
            
            inputSection.classList.add('hidden');
            
            const randomFortune = getRandomFortune();
            fortuneContent.textContent = randomFortune;
            
            fortuneDisplay.classList.remove('hidden');
            setTimeout(() => fortuneDisplay.classList.add('show'), 100);
        }

        function reset() {
            const input = document.getElementById('wisdom-input');
            const inputSection = document.getElementById('input-section');
            const fortuneDisplay = document.getElementById('fortune-display');
            
            fortuneDisplay.classList.remove('show');
            setTimeout(() => {
                fortuneDisplay.classList.add('hidden');
                inputSection.classList.remove('hidden');
                input.value = '';
            }, 400);
        }

        function updateCountDisplay() {
            document.querySelector('.count-number').textContent = window.fortuneCount;
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }
    </script>
</body>
</html>